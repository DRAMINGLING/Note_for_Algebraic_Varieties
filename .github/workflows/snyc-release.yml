name: sync release

# 触发条件：可选（按需选择）
on:
  # 1. 手动触发（推荐测试用）
  workflow_dispatch:
  # 2. 当有新Release发布时自动触发
  release:
    types: [published]

jobs:
  push-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予写入仓库内容的权限
    steps:
      - name: 1. 设置环境变量（需修改的核心配置）
        id: set-env
        run: |
          # ========== 需要用户修改的变量 ==========
          # 源仓库信息（一般无需修改，因为工作流在该仓库运行）
          echo "SOURCE_OWNER=DRAMINGLING" >> $GITHUB_ENV
          echo "SOURCE_REPO=Note_for_Algebraic_Varieties" >> $GITHUB_ENV
          
          # 目标仓库信息（必须修改为你的Documents仓库信息）
          echo "TARGET_OWNER=DRAMINGLING" >> $GITHUB_ENV  # 替换为你的GitHub用户名
          echo "TARGET_REPO=Documents" >> $GITHUB_ENV     # 替换为你的目标仓库名
          
          # PDF文件存储路径（可选修改：Documents仓库中存储PDF的目录）
          echo "PDF_TARGET_DIR=Algebraic_Varieties" >> $GITHUB_ENV  # 目标仓库中的子目录，不存在会自动创建
          
          # 提交信息（可选修改）
          echo "COMMIT_MESSAGE=Update main.pdf from Note_for_Algebraic_Varieties release" >> $GITHUB_ENV
          # =======================================

      - name: 2. 下载release中的main.pdf文件
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: ${{ env.SOURCE_OWNER }}/${{ env.SOURCE_REPO }}
          tag: release
          file: main.pdf
          target: ./main.pdf
          token: ${{ secrets.UPDATE_TEX_FILE }}  # 使用指定的secret名称

      - name: 3. 克隆目标Documents仓库
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_OWNER }}/${{ env.TARGET_REPO }}
          token: ${{ secrets.UPDATE_TEX_FILE }}  # 用于克隆私有仓库（若为公有也需要）
          path: target-repo  # 克隆到target-repo目录

      - name: 4. 准备目标目录并复制PDF文件
        run: |
          # 创建目标目录（若不存在）
          mkdir -p ./target-repo/${{ env.PDF_TARGET_DIR }}
          # 复制下载的PDF到目标目录
          cp ./main.pdf ./target-repo/${{ env.PDF_TARGET_DIR }}/main.pdf

      - name: 5. 提交并推送文件到Documents仓库
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: ./target-repo  # 指定仓库目录
          commit_message: ${{ env.COMMIT_MESSAGE }}
          file_pattern: ${{ env.PDF_TARGET_DIR }}/main.pdf  # 仅提交该文件
          push_options: --force-with-lease  # 安全推送（避免覆盖未同步的更改）
          branch: main  # 目标仓库的主分支（若为master需修改）
