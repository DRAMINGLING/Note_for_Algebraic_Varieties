name: Sync Release PDF to Documents Repository

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°releaseï¼‰'
        required: false
        default: ''

permissions:
  contents: write
  packages: read

jobs:
  sync-pdf-file:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡ï¼ˆå®‰è£…å¿…è¦å·¥å…·ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          # ä¸´æ—¶å…³é—­å‚æ•°é•¿åº¦é™åˆ¶ï¼ˆéƒ¨åˆ†ç³»ç»Ÿæœ‰æ•ˆï¼Œè¾…åŠ©æªæ–½ï¼‰
          ulimit -s unlimited || true

      - name: 2. è·å–ç›®æ ‡Releaseçš„PDFæ–‡ä»¶ä¿¡æ¯
        id: get_release_asset
        env:
          OWNER: DRAMINGLING          # éœ€è¦ä¿®æ”¹ï¼šGitHubç”¨æˆ·å
          SOURCE_REPO: Note_for_Algebraic_Varieties  # éœ€è¦ä¿®æ”¹ï¼šæºä»“åº“å
          ASSET_NAME: main.pdf        # éœ€è¦ä¿®æ”¹ï¼šæºReleaseä¸­çš„æ–‡ä»¶å
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}
        run: |
          # è·å–Releaseä¿¡æ¯
          if [ -z "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$SOURCE_REPO/releases/latest")
          else
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$SOURCE_REPO/releases/tags/${{ github.event.inputs.release_tag }}")
          fi

          # æå–PDFä¸‹è½½URL
          ASSET_URL=$(echo "$RELEASE_INFO" | jq -r --arg name "$ASSET_NAME" \
            '.assets[] | select(.name == $name) | .browser_download_url')

          if [ "$ASSET_URL" = "null" ] || [ -z "$ASSET_URL" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªåœ¨Releaseä¸­æ‰¾åˆ°åä¸º $ASSET_NAME çš„æ–‡ä»¶"
            exit 1
          fi

          echo "ASSET_URL=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: 3. ä¸‹è½½PDFæ–‡ä»¶å¹¶æ£€æµ‹å¤§å°
        id: download_file
        run: |
          # ä¸‹è½½æ–‡ä»¶ï¼ˆä½¿ç”¨--limit-rateé¿å…å¸¦å®½è¶…é™ï¼‰
          curl -s -L --limit-rate 5M ${{ steps.get_release_asset.outputs.ASSET_URL }} -o main.pdf
          
          # æ£€æµ‹æ–‡ä»¶å¤§å°ï¼ˆå•ä½ï¼šMBï¼‰
          FILE_SIZE=$(du -m main.pdf | awk '{print $1}')
          echo "ğŸ“„ ä¸‹è½½çš„PDFæ–‡ä»¶å¤§å°ï¼š$FILE_SIZE MB"
          
          # GitHub API å•æ¬¡ä¸Šä¼ æœ€å¤§æ”¯æŒ100MBï¼ˆBase64åä¼šè†¨èƒ€~37%ï¼Œæ‰€ä»¥é™åˆ¶åŸæ–‡ä»¶70MBï¼‰
          MAX_SIZE=70
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶å¤§å°ï¼ˆ$FILE_SIZE MBï¼‰è¶…è¿‡é™åˆ¶ï¼ˆ$MAX_SIZE MBï¼‰ï¼ŒBase64åä¼šè¶…å‡ºAPIä¸Šé™"
            exit 1
          fi

      - name: 4. ç”ŸæˆBase64æ–‡ä»¶ï¼ˆæ— å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ï¼‰
        run: |
          # ç›´æ¥å†™å…¥Base64æ–‡ä»¶ï¼Œä¸é€šè¿‡å‘½ä»¤è¡Œä¼ é€’å†…å®¹
          base64 -w 0 main.pdf > pdf_base64.txt
          echo "âœ… Base64æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå¤§å°ï¼š$(du -k pdf_base64.txt | awk '{print $1}') KB"

      - name: 5. æ„é€ APIè¯·æ±‚ä½“ï¼ˆå®Œå…¨è„±ç¦»å‘½ä»¤è¡Œå‚æ•°ï¼‰
        run: |
          # æ­¥éª¤1ï¼šåˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶ï¼ˆä»…åŒ…å«éè¶…é•¿å­—æ®µï¼‰
          cat > metadata.json << EOF
          {
            "message": "Sync PDF from Note_for_Algebraic_Varieties release (size: ${{ steps.download_file.outputs.FILE_SIZE }}MB)",
            "branch": "main"
          }
          EOF

          # æ­¥éª¤2ï¼šç”¨jqçš„--slurpfileè¯»å–è¶…é•¿Base64æ–‡ä»¶ï¼Œç®¡é“ä¼ é€’é¿å…å‚æ•°é—®é¢˜
          # æ ¸å¿ƒï¼šslurpfileè¯»å–æ–‡ä»¶å†…å®¹ï¼Œä¸ç»è¿‡å‘½ä»¤è¡Œå‚æ•°
          jq --slurpfile content pdf_base64.txt \
            '.content = $content[0]' metadata.json > payload.json

          # éªŒè¯payloadï¼ˆä»…è¾“å‡ºå‰100å­—ç¬¦ï¼Œé¿å…æ—¥å¿—åˆ·å±ï¼‰
          echo "âœ… è¯·æ±‚ä½“ç”Ÿæˆå®Œæˆï¼Œå‰100å­—ç¬¦ï¼š$(head -c 100 payload.json)..."

      - name: 6. æ¨é€æ–‡ä»¶åˆ°Documentsä»“åº“ï¼ˆæ— å‚æ•°ä¼ é€’ï¼‰
        env:
          OWNER: DRAMINGLING          # éœ€è¦ä¿®æ”¹ï¼šGitHubç”¨æˆ·å
          TARGET_REPO: Documents       # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡ä»“åº“å
          TARGET_FILENAME: Note for Algebraic Varieties  # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡æ–‡ä»¶å
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}
        run: |
          # å¯¹ç›®æ ‡æ–‡ä»¶ååšURLç¼–ç ï¼ˆé¿å…ç©ºæ ¼/ç‰¹æ®Šå­—ç¬¦ï¼‰
          ENCODED_FILENAME=$(echo -n "$TARGET_FILENAME" | jq -sRr @uri)
          
          # æ¨é€æ–‡ä»¶ï¼šç”¨@payload.jsonä¼ é€’è¯·æ±‚ä½“ï¼Œæ— å‘½ä»¤è¡Œå‚æ•°ä¼ é€’è¶…é•¿å†…å®¹
          RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @payload.json \
            "https://api.github.com/repos/$OWNER/$TARGET_REPO/contents/$ENCODED_FILENAME")

          # æ£€æŸ¥ç»“æœ
          if echo "$RESPONSE" | jq -e '.commit' > /dev/null; then
            echo "âœ… æ–‡ä»¶æ¨é€æˆåŠŸï¼Commit SHA: $(echo "$RESPONSE" | jq -r '.commit.sha')"
          else
            echo "âŒ æ–‡ä»¶æ¨é€å¤±è´¥ï¼š$(echo "$RESPONSE" | jq -r '.message // .')"
            exit 1
          fi

      - name: 7. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f main.pdf pdf_base64.txt metadata.json payload.json
